# Security hardening for GitHub Actions
# https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions

name: '[Scheduled] Harja: Prod deployment'
run-name: 'Harja: Deploy to production'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  # Manuaalisen käynnistyksen asetukset
  workflow_dispatch:
  # Ajastettu käynnistys (Ajetaan deployment joka arkipäivä klo 7 (Huom, GitHub actions on UTC-aikavyöhykkeessä))
  #schedule:
  #  - cron: '0 4 * * 1-5'

# TODO:
#  - Hae viimeisin onnistunut build ja sen tiedot (run_id ja liittyvä commit SHA)
#  - Muokkaa reusable_deploy-harja-image-to-ecs.yml tiedostoa niin, että se ottaa parametrina viimeisimmän onnistuneen buildin tiedot
#    - Muokkaa jobia niin, että se hakee viimeisimmän build artifactin run_id:n perusteella
#    - Muokkaa jobia niin, että se ajaa migraatiot jobille annetun commit SHA:n perusteella
#    - Lisää reusable_deploy-harja-image-to-ecs.yml omaksi jobin ajoksi tähän workflowhun
#  - Hae get-last-successful-build jobin outputista viimeisin onnistunut buildin run_id ja commit SHA

jobs:

  get-latest-succesful-build:
    runs-on: ubuntu-latest
    env:
      # Scriptin käyttämät ympäristömuuttujat
      WORKFLOW_ID: 'harja_build_and_deploy.yml'
      BRANCH_NAME: 'develop'
    steps:
      - name: TODO
        run: |
          echo "TODO"

# Security hardening for GitHub Actions
# https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions

name: 'Harja: Test and build (PR)'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  # Manuaalisen käynnistyksen asetukset
  workflow_dispatch:
  # Jobi ajetaan automaattisesti jokaiselle PR:lle, jonka base branch on develop
#  pull_request:
#    branches: [ develop ]

# Tässä voi määritellä yhteiset permissionit kaikille jobeille workflowissa tarvittaessa
# README: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
permissions:
  # Contents read lupaa tarvitaan checkout actionissa
  contents: read
  # Packages read lupaa tarvitaan Harjan testaukseen tarkoitettujen Docker imageiden pullaamiseen
  packages: read

env:
  GH_DOCKER_REGISTRY: ghcr.io

jobs:
  # Build job
  build:
    name: "Prod build"
    runs-on: ubuntu-latest
    # README: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
    permissions:
      # Contents read lupaa tarvitaan checkout actionissa
      contents: read
      # Packages read lupaa tarvitaan Harjan testaukseen tarkoitettujen Docker imageiden pullaamiseen
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Käynnistetään testitietokanta docker-kontti, jota tarvitaan testien ajamiseen ja Harjan buildaamiseen
      - name: Start test database
        uses: ./.github/actions/start-test-db
        with:
          registry: ${{ env.GH_DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup clojure environment
        uses: ./.github/actions/setup-clojure-env

      #- name: Run unit tests
      #  run: lein test2junit

      # Buildataan Harjan osat erillisinä palasina
      - name: Build back-end
        run: |
          echo "Building backend"
          lein do compile
      - name: Build front-end
        run: |
          echo "Building frontend"
          lein do less once, with-profile prod-cljs compile-prod

      # TODO: Disabloitu toistaiseksi buildin testailun nopeuttamiseksi.
      #- name: Build laadunseuranta
      #  run: |
      #    echo "Building laadunseuranta"
      #    lein do with-profile laadunseuranta-prod compile-laadunseuranta-prod
      #- name: Build documentation
      #  run: |
      #    echo "Building documentation"
      #    lein codox

      # Buildataan lopuksi uberjar
      - name: Build uberjar
        run: |
          echo "Building uberjar"
          lein uberjar

      - name: Name build artifact using the branch name
        id: artifact-name
        env:
          REF: ${{ github.ref }}
        run: echo "::set-output name=value::${REF////-}-uberjar"

      - name: Delete old branch build artifacts (only latest is needed)
        uses: actions/github-script@v4
        id: artifact
        with:
          script: |
            const { owner, repo } = context.issue

            const res = await github.actions.listArtifactsForRepo({
              owner,
              repo,
            })

            res.data.artifacts
              .filter(({ name }) => name === '${{ steps.artifact-name.outputs.value }}')
              .forEach(({ id }) => {
                github.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: id,
                })
              })

      - name: Upload a new build artifact
        uses: actions/upload-artifact@v3
        with:
          name: harja-uberjar
          #name: ${{ steps.artifact-name.outputs.value }}
          path: ./target/harja-0.0.1-SNAPSHOT-standalone.jar
          if-no-files-found: error
          retention-days: 1

  # Ajaa esim. perustestit (back-testit, front-testit, integraatiotestit
  # -- OHJEITA KEHITYKSEEN --
  # TODO: Jos testien ajoa haluaa pilkkoa erillisiksi Status Checkeiksi, niin ne pitää pilkkoa erillisiksi jobeiksi.
  #       Halutut status checkit valikoidaan Harjan Github-repon asetuksista.
  #       Jokainen jobi ajetaan omassa VM:ssä, joten perusasiat ja tarvittaessa testitietokannan käynnistys action
  #       pitää ottaa mukaan jobiin.
  #
  # Tässä ei tarvitse käyttää mitään CircleCI:ssä käytettyjä docker imageita. Tavoitellaan yksinkertaisuutta ja suoraviivaisuutta.
  #
  # Tarvittavat depsut, esim. phantom voi asentaa suoraan tässä jobissa.
  # Halutessaan testien depsujen asentelusta voi tehdä erillisen composite-actionin ja tallentaa sen .github/actions kansioon
  # Katso esimerkiksi mitä "Setup Clojure environment" action tekee: Se asentaa java-11 ja clojure-työkalut.
  #
#  basic-tests:
#    name: "Perustestit"
#    runs-on: ubuntu-latest
#    # README: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
#    permissions:
#      # Contents read lupaa tarvitaan checkout actionissa
#      contents: read
#      # Packages read lupaa tarvitaan Harjan testaukseen tarkoitettujen Docker imageiden pullaamiseen
#      packages: read
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      # Käynnistetään testitietokanta docker-kontti, jota tarvitaan testien ajamiseen
#      - name: Start test database
#        uses: ./.github/actions/start-test-db
#        with:
#          registry: ${{ env.GH_DOCKER_REGISTRY }}
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Setup clojure environment
#        uses: ./.github/actions/setup-clojure-env
#
#      # TODO: Aja halutut testit
#      #- name: Run unit tests jne.
#      #  run: lein test2junit
#
#      #

  e2e-tests:
    name: "e2e-testit (Cypress)"
    #needs: build
    runs-on: ubuntu-latest
    env:
      # Asetetaan Suomen aikavyöhyke testejä varten
      TZ: "EET"
      HARJA_SALLI_OLETUSKAYTTAJA: "true"
      HARJA_DEV_YMPARISTO: "false"

    # README: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
    permissions:
      # Contents read lupaa tarvitaan checkout actionissa
      contents: read
      # Packages read lupaa tarvitaan Harjan testaukseen tarkoitettujen Docker imageiden pullaamiseen
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check ENV
        run: |
          echo "Salli harjan oletuskäyttäjä? ${HARJA_SALLI_OLETUSKAYTTAJA}"
          echo "Harja dev ympäristö? ${HARJA_DEV_YMPARISTO}"
          echo "Aikavyöhyke: ${TZ}"

      # Käynnistetään testitietokanta docker-kontti, jota tarvitaan testien ajamiseen
      - name: Start test database
        uses: ./.github/actions/start-test-db
        with:
          registry: ${{ env.GH_DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Asenna pelkkä java
      - name: Prepare java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Get the build artifact name
        id: artifact-name
        env:
          REF: ${{ github.ref }}
        run: echo "::set-output name=value::${REF////-}-uberjar"

      - name: Download uberjar artifact
        uses: actions/download-artifact@v3
        with:
          name: harja-uberjar
          #name: ${{ steps.artifact-name.outputs.value }}
          # Downloads to the same directory as the uberjar is built to
          path: ./target

      - name: Start Harja jar
        run: |
          java -cp :harja.jar harja.palvelin.main > harja.out 2>&1 &
          javapid=$!
          
          for i in $(seq 4); do
            curl localhost:3000 > /dev/null 2>&1 && break
            if kill -0 $javapid; then
              echo "Harja ei ole vielä käynnissä, odotetaan 10 sec..."
              sleep 10
            else
              echo "Harja ei käynnisty. Lopetetaan..."
              cat harja.out
              exit 1
            fi
          done

      - name: Run cypress
        uses: ./.github/actions/start-cypress
        with:
          registry: ${{ env.GH_DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_WORKSPACE: ${{ env.GITHUB_WORKSPACE }}

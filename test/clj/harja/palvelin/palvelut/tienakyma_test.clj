(ns harja.palvelin.palvelut.tienakyma-test
  (:require [clojure.test :as t :refer [deftest is use-fixtures testing]]
            [harja.testi :refer :all]
            [com.stuartsierra.component :as component]
            [harja.palvelin.komponentit.tietokanta :as tietokanta]
            [harja.palvelin.palvelut.tienakyma :as tienakyma]
            [slingshot.slingshot :refer [try+]]
            [harja.paneeliapurit :as paneeli])
  (:import [harja.domain.roolit EiOikeutta]))

(defn jarjestelma-fixture [testit]
  (alter-var-root #'jarjestelma
                  (fn [_]
                    (component/start
                     (component/system-map
                      :db (tietokanta/luo-tietokanta testitietokanta)
                      :http-palvelin (testi-http-palvelin)
                      :tienakyma (component/using
                                  (tienakyma/->Tienakyma)
                                  [:db :http-palvelin])))))
  (testit)
  (alter-var-root #'jarjestelma component/stop))

(use-fixtures :once jarjestelma-fixture)

(defn- kutsu
  ([kayttaja payload] (kutsu :hae-tienakymaan kayttaja payload))
  ([palvelu kayttaja payload]
   (kutsu-palvelua (:http-palvelin jarjestelma) palvelu kayttaja payload)))

(def parametrit
  {:sijainti {:type :multiline, :lines [{:type :line, :points [[426938.1807000004 7212765.558800001] [426961.68209999986 7212765.378899999] [426978.40299999993 7212763.941300001] [426991.6160000004 7212762.211199999] [427003.70409999974 7212760.276799999] [427016.42399999965 7212757.082199998] [427042.9341000002 7212749.463199999] [427062.1152999997 7212743.1592999995] [427075.5290000001 7212738.3829] [427090.1869000001 7212730.16] [427118.74810000043 7212720.131999999] [427140.2329000002 7212713.313999999] [427166.05989999976 7212706.0953] [427188.8476999998 7212699.264800001] [427222.3342000004 7212689.9562] [427258.6191999996 7212680.644099999] [427287.90579999983 7212673.449700002] [427326.05429999996 7212665.229800001] [427357.16390000004 7212658.2249] [427400.93090000004 7212649.327199999] [427448.4773000004 7212639.177099999] [427490.2276999997 7212629.6559000015] [427526.81819999963 7212621.5123] [427559.56620000023 7212613.999299999] [427580.88599999994 7212609.107999999] [427590.5822999999 7212606.869899999] [427610.52219999954 7212602.362100001] [427615.8970999997 7212600.879700001] [427647.15199999977 7212593.494199999] [427689.2229000004 7212583.002300002] [427709.48319999967 7212577.989999998] [427746.5911999997 7212568.629099999] [427778.3041000003 7212561.2269] [427806.25490000006 7212554.617899999] [427839.5072999997 7212547.4069] [427860.08029999956 7212543.011100002] [427895.9709999999 7212534.8442] [427916.80119999964 7212530.625300001] [427946.20100000035 7212523.061099999] [427980.9601999996 7212515.0097] [428008.1026999997 7212508.842099998] [428033.14300000016 7212503.239100002] [428036.1649000002 7212502.470800001] [428039.93769999966 7212501.8431] [428052.5789999999 7212499.2870000005] [428077.767 7212493.766800001] [428101.18319999985 7212489.379299998] [428120.8348000003 7212485.786899999] [428138.9891999997 7212482.508900002] [428171.61930000037 7212477.621800002] [428205.13489999995 7212472.208700001] [428240.3229 7212467.392999999] [428272.68790000025 7212462.022300001] [428307.63889999967 7212456.074999999] [428329.73890000023 7212451.820999999] [428358.65380000044 7212446.267999999] [428378.7909000004 7212442.411200002] [428418.4461000003 7212433.486699998] [428437.7511 7212429.4131000005] [428464.0909000002 7212423.851199999] [428494.84669999965 7212417.3048] [428518.0711000003 7212412.1842] [428542.71889999975 7212407.6019] [428564.4681000002 7212402.537900001] [428572.32409999985 7212400.806000002] [428583.62600000016 7212398.582199998] [428594.2287999997 7212396.743099999] [428638.7807 7212386.620999999] [428659.32629999984 7212382.0042] [428681.51499999966 7212375.4978] [428695.2712000003 7212370.025800001] [428709.2329000002 7212363.995200001] [428735.66920000035 7212351.858899999] [428756.59530000016 7212342.525899999] [428779.0443000002 7212332.524099998] [428797.33389999997 7212325.9032000005] [428811.267 7212320.780200001] [428821.0078999996 7212318.462900002] [428841.39919999987 7212313.9373] [428866.03089999966 7212310.060800001] [428876.25009999983 7212308.867899999] [428887.3287000004 7212308.281300001] [428901.9031999996 7212308.306299999] [428914.6660000002 7212308.4087000005] [428919.9582000002 7212308.467099998] [428934.4308000002 7212308.169300001] [428940.6180999996 7212308.371199999] [428950.51209999993 7212308.596900001] [428958.37710000016 7212308.2157000005] [428966.1639999999 7212308.181200001] [428970.84920000006 7212308.062100001] [428979.06680000015 7212307.813099999] [428990.3008000003 7212307.053199999] [429014.16899999976 7212302.812199999] [429028.6350999996 7212299.733800001] [429042.9040999999 7212296.071699999] [429055.5697999997 7212293.205899999] [429061.5039999997 7212291.6532999985] [429068.32189999986 7212290.095899999] [429081.53199999966 7212287.489100002] [429093.36400000006 7212285.077100001] [429112.4159000004 7212280.954100002] [429126.4961000001 7212277.4772000015] [429140.9818000002 7212274.523800001] [429162.80069999956 7212269.8332] [429177.8367999997 7212266.667800002] [429181.4589999998 7212266.038899999] [429184.83220000006 7212265.2217999995] [429194.64109999966 7212263.3083] [429203.7960000001 7212261.3959] [429205.2807 7212261.189800002] [429209.0762 7212260.504999999] [429211.90809999965 7212259.946899999] [429226.85720000044 7212257.4551] [429241.9219000004 7212254.094999999] [429257.9601999996 7212251.2190000005] [429287.1551000001 7212248.044100001] [429367.05819999985 7212248.589000002] [429438.78369999956 7212250.982000001] [429485.28610000014 7212253.847199999] [429491.1869000001 7212253.9342] [429497.1627000002 7212254.170000002] [429561.9469999997 7212258.2359] [429620.43319999985 7212263.0933] [429648.48819999956 7212265.3028] [429676.8529000003 7212268.813000001] [429697.1327999998 7212271.413199998] [429719.85280000046 7212274.377900001] [429756.8881999999 7212280.363899998] [429787.68090000004 7212285.2217999995] [429809.8119000001 7212288.730900001] [429817.21109999996 7212290.144099999] [429822.40020000003 7212291.445999999] [429872.38599999994 7212302.073199999] [429891.66779999994 7212306.4672] [429912.31819999963 7212310.8451000005] [429976.0990000004 7212327.326000001] [430025.2319 7212339.764899999] [430078.0937000001 7212353.759300001] [430108.6827999996 7212361.4188] [430124.41390000004 7212365.839000002] [430215.3211000003 7212391.465300001] [430294.3898 7212416.123199999] [430353.34420000017 7212435.1501] [430407.76690000016 7212454.995900001] [430448.0678000003 7212471.5649] [430466.05119999964 7212478.821800001] [430476.9363000002 7212483.3433] [430494.72080000024 7212490.9081000015] [430509.801 7212497.9267] [430518.18290000036 7212501.960999999] [430574.97890000045 7212533.2201000005] [430624.29590000026 7212561.9177] [430639.4117999999 7212571.5287999995] [430645.8289000001 7212575.383900002] [430650.8690999998 7212578.826200001]]} {:type :line, :points [[430650.8690999998 7212578.826200001] [430667.3690999998 7212589.979200002] [430697.84970000014 7212610.5337000005] [430797.84219999984 7212680.199200001] [430825.79119999986 7212700.691199999] [430897.84130000044 7212750.7062] [430928.35890000034 7212773.0438] [430970.2648 7212802.532900002] [431004.76719999965 7212826.579700001] [431036.58910000045 7212848.2051] [431081.49899999984 7212879.362300001] [431120.6730000004 7212907.093899999] [431176.23510000017 7212944.9881] [431190.3718999997 7212954.377] [431212.99120000005 7212970.697700001] [431217.44299999997 7212973.957800001] [431227.92179999966 7212981.794199999] [431236.64080000017 7212988.002900001] [431279.48819999956 7213019.254799999] [431350.78369999956 7213069.930300001] [431397.51130000036 7213102.947999999] [431418.0217000004 7213118.3039] [431426.40479999967 7213124.780000001] [431449.0312000001 7213142.281100001] [431486.14109999966 7213172.539099999] [431553.4737 7213237.333999999] [431607.22109999973 7213289.506700002] [431635.9561999999 7213316.2128] [431669.8350999998 7213343.385699999] [431693.87430000026 7213361.535999998] [431733.8869000003 7213390.1477999985] [431753.04000000004 7213402.800999999] [431762.39630000014 7213408.574999999] [431772.32600000035 7213415.306000002] [431789.59420000017 7213425.862199999] [431813.2527999999 7213439.6631000005] [431851.7401999999 7213459.513099998] [431873.2922 7213470.677999999] [431884.73170000035 7213476.3977999985] [431908.3258999996 7213488.2118999995] [431941.4068 7213504.964899998] [431994.2072999999 7213532.9562] [432023.09300000034 7213549.133900002] [432058.4603000004 7213571.4441] [432079.67229999974 7213584.433899999] [432091.45720000006 7213591.643100001] [432122.8317999998 7213610.354899999] [432192.97190000024 7213660.584899999] [432263.5652999999 7213710.3629] [432335.5153000001 7213760.366] [432381.2189999996 7213793.853100002] [432410.90529999975 7213815.437899999] [432427.90490000043 7213827.798099998] [432447.63269999996 7213841.1833] [432497.0641000001 7213874.629299998] [432551.81799999997 7213914.9026999995] [432622.4112999998 7213965.360199999] [432674.9031999996 7214000.8829] [432817.3071999997 7214101.145799998] [432836.9397999998 7214115.888799999] [432859.9402999999 7214132.1732] [432871.0421000002 7214139.798099998] [432909.88019999955 7214167.2289] [432921.6068000002 7214175.482799999] [433104.14190000016 7214303.024] [433129.23220000044 7214321.8752] [433148.14169999957 7214335.5469] [433167.8261000002 7214350.3519] [433211.79619999975 7214381.220800001] [433256.7429999998 7214413.035] [433296.0027999999 7214440.179900002] [433336.21079999954 7214468.0009] [433425.7440999998 7214531.7809999995] [433510.8362999996 7214588.7861] [433514.48110000044 7214591.227899998] [433534.99810000043 7214606.276999999] [433544.3108000001 7214613.133099999] [433555.49179999996 7214620.802700002] [433564.9707000004 7214627.400899999] [433597.88790000044 7214651.456099998] [433673.21889999975 7214705.866900001] [433736.3718999997 7214753.581900001] [433765.24990000017 7214775.1822] [433777.02890000027 7214785.1072] [433867.3976999996 7214857.1578] [433907.51690000016 7214889.3977999985] [433929.68599999975 7214907.2782000005] [433959.3287000004 7214932.264899999] [433991.3077999996 7214956.165899999] [434016.6827999996 7214973.687800001] [434038.0979000004 7214989.4778] [434067.0318999998 7215010.574299999] [434087.5602000002 7215024.5419000015] [434103.0691999998 7215035.074999999] [434115.06010000035 7215043.587299999] [434134.39910000004 7215057.148800001] [434146.49370000046 7215064.8440000005] [434174.8356999997 7215083.390299998] [434212.27080000006 7215107.756900001] [434268.1752000004 7215143.9758] [434328.58270000014 7215183.2392] [434377.1201999998 7215214.632300001] [434408.7770999996 7215234.946800001] [434473.1509999996 7215277.015799999] [434517.0228000004 7215305.214899998] [434527.14020000026 7215311.809] [434542.767 7215321.988299999] [434557.06099999975 7215331.5053] [434593.05119999964 7215355.736200001] [434640.86620000005 7215388.8467999995] [434685.7302000001 7215421.796700001] [434742.51910000015 7215463.945] [434764.10869999975 7215480.302000001] [434776.60589999985 7215490.381200001] [434784.2242999999 7215501.512800001] [434809.3788999999 7215521.085200001] [434838.86199999973 7215543.855799999] [434874.7319 7215571.1437] [434887.91220000014 7215581.155099999] [434912.2241000002 7215598.388099998] [434930.8799999999 7215612.224800002] [434937.8569 7215617.2798999995] [434951.95019999985 7215627.666999999] [434959.61980000045 7215632.997200001] [434975.3200000003 7215644.3182] [434996.00430000015 7215659.035100002] [435041.61870000046 7215692.903900001] [435113.12679999974 7215744.905099999] [435177.46499999985 7215791.140099999] [435211.30399999954 7215815.896200001] [435234.2687999997 7215832.151999999] [435265.3819000004 7215854.873100001] [435283.7037000004 7215867.7283000015] [435305.53270000033 7215883.891100001] [435342.57880000025 7215910.822299998] [435363.89690000005 7215926.318700001] [435402.9911000002 7215954.800099999] [435450.2390999999 7215990.493099999] [435497.8141000001 7216027.270100001] [435536.00189999957 7216057.0331000015] [435591.5860000001 7216100.311700001] [435609.23780000024 7216113.818999998] [435622.8110999996 7216123.636799999] [435634.9068999998 7216128.915199999] [435652.8987999996 7216140.832899999] [435676.6799999997 7216157.188200001] [435699.5231999997 7216174.2128] [435745.2871000003 7216209.512699999] [435760.1040000003 7216221.192200001] [435773.45529999956 7216231.416200001] [435788.0982999997 7216242.9026999995] [435805.5641999999 7216257.586199999] [435810.62229999993 7216261.512699999] [435814.9258000003 7216265.059900001]]} {:type :line, :points [[435814.9258000003 7216265.059900001] [435831.51389999967 7216278.0669] [435882.8587999996 7216318.374299999] [435913.49370000046 7216343.095899999] [435933.2840999998 7216359.684] [435955.88019999955 7216379.432700001] [435964.6808000002 7216387.1547] [435971.7106999997 7216393.2652] [435977.7181000002 7216401.542199999] [435988.6858999999 7216410.809700001] [436002.33019999973 7216422.184300002] [436016.6659000004 7216433.671999998] [436065.59279999975 7216472.4179] [436104.5011999998 7216502.842] [436160.72310000006 7216547.196199998] [436209.9698999999 7216586.139199998] [436292.3230999997 7216651.573800001] [436337.4419999998 7216687.562800001] [436395.23199999984 7216733.535700001] [436432.8230999997 7216763.105799999] [436446.1969999997 7216773.706099998] [436458.22310000006 7216783.135000002] [436478.5851999996 7216794.932999998] [436498.41199999955 7216809.443799999] [436514.99289999995 7216822.110199999] [436536.86479999963 7216839.524300002] [436564.4617999997 7216861.434900001] [436582.7441999996 7216875.971299998] [436594.57079999987 7216885.220899999] [436598.8398000002 7216888.664999999] [436602.4989 7216891.785700001] [436614.2648 7216901.031800002] [436631.7187999999 7216915.288899999] [436639.4539000001 7216921.416000001] [436661.40919999965 7216938.805100001] [436694.6317999996 7216965.811299998] [436717.15699999966 7216984.900699999] [436737.3518000003 7217003.217700001] [436744.99820000026 7217013.205800001] [436755.8272000002 7217022.712699998] [436772.79110000003 7217037.094300002] [436782.52610000037 7217046.0449] [436806.15309999976 7217068.492699999] [436823.25100000016 7217085.784699999] [436844.0406999998 7217107.959800001] [436871.2399000004 7217138.922899999] [436899.0220999997 7217173.794] [436925.4321999997 7217210.0123] [436946.2279000003 7217240.8378] [436963.3502000002 7217268.0691] [436980.49930000026 7217297.792800002] [436997.5292999996 7217330.353799999] [437019.2302000001 7217373.289999999] [437034.82490000036 7217405.350099999] [437046.5389999999 7217429.905000001] [437060.97169999965 7217461.040199999] [437069.892 7217480.878199998] [437116.30979999993 7217579.0352] [437147.24789999984 7217644.584800001] [437174.69299999997 7217702.539799999] [437210.4556999998 7217779.740800001] [437234.71219999995 7217831.3477] [437253.9528999999 7217873.173799999] [437275.0630999999 7217918.1087] [437305.4241000004 7217982.8988999985] [437335.7553000003 7218046.9089] [437363.14020000026 7218106.9329] [437392.18680000026 7218166.987799998] [437402.76099999994 7218188.563700002] [437403.86569999997 7218190.791099999] [437405.14499999955 7218193.2727999985] [437443.01769999973 7218273.704799999] [437464.96410000045 7218320.7283000015] [437491.98869999964 7218377.087200001] [437505.5943 7218406.055100001] [437516.65500000026 7218430.490899999] [437525.5948999999 7218440.5779] [437531.6498999996 7218451.9888] [437540.5547000002 7218469.7722] [437562.92509999964 7218516.988000002] [437565.7259999998 7218522.713100001] [437568.8021 7218528.370900001] [437577.3650000002 7218546.7201000005] [437595.7337999996 7218586.243700001] [437607.9148000004 7218613.573899999] [437614.5939999996 7218630.4562] [437617.62179999985 7218645.348700002] [437628.4787999997 7218667.837000001] [437641.0898000002 7218694.703299999] [437656.53500000015 7218727.9998] [437684.9770999998 7218788.0779] [437710.7570000002 7218843.145] [437720.73500000034 7218864.445799999] [437744.7449000003 7218915.9657999985] [437760.92509999964 7218950.162700001] [437770.9263000004 7218963.4091] [437776.78720000014 7218973.923700001] [437783.9868999999 7218987.984299999] [437799.49820000026 7219019.610800002] [437805.56099999975 7219031.907900002] [437810.4148000004 7219042.321800001] [437818.46970000025 7219059.2958] [437826.3417999996 7219076.490800001] [437829.9187000003 7219084.287300002] [437843.6010999996 7219114.492199998] [437863.7149 7219159.727299999] [437884.1377999997 7219205.3673] [437898.46219999995 7219236.113000002] [437920.3048999999 7219283.006099999] [437935.0889999997 7219314.7892] [437950.0928999996 7219347.034000002] [437972.926 7219395.522] [438019.49870000035 7219491.131700002] [438054.9112 7219563.810699999] [438063.92619999964 7219582.388] [438066.40610000025 7219587.238200001] [438068.98429999966 7219592.616099998] [438070.08779999986 7219595.047200002] [438071.20689999964 7219597.693799999] [438074.84810000006 7219605.0722] [438097.1070999997 7219652.5781] [438104.55700000003 7219668.511100002] [438111.20880000014 7219683.404199999] [438117.62710000016 7219698.443300001] [438119.4900000002 7219703.0678] [438120.7383000003 7219713.613899998] [438134.6617999999 7219743.431699999] [438149.9968999997 7219776.1589] [438165.7131000003 7219809.522100002] [438186.2050999999 7219852.675000001] [438208.08110000007 7219896.2401] [438223.7781999996 7219925.252799999] [438230.4330000002 7219937.614799999] [438250.4639999997 7219971.477000002] [438274.7139999997 7220009.473099999] [438308.03729999997 7220058.077799998] [438342.56709999964 7220106.533] [438380.2779000001 7220158.1239] [438421.4327999996 7220214.803800002] [438457.85419999994 7220264.844999999] [438499.73029999994 7220322.504000001] [438519.15919999965 7220348.762800001] [438524.4751000004 7220357.578200001] [438525.3088999996 7220358.796100002] [438542.5800999999 7220381.111099999] [438582.17700000014 7220435.373] [438617.31379999965 7220482.0922] [438651.84190000035 7220524.725900002] [438676.59329999983 7220554.256000001] [438706.9709000001 7220585.281100001] [438733.43989999965 7220610.93] [438772.40020000003 7220646.153099999] [438807.7977999998 7220675.006700002] [438838.41899999976 7220697.892200001] [438838.8728 7220698.2311] [438862.5469000004 7220714.202799998] [438866.8540000003 7220717.004900001] [438867.2488000002 7220717.267000001] [438923.01570000034 7220752.311999999] [438972.4678999996 7220780.3741] [439016.1462000003 7220805.609700002] [439082.6599000003 7220843.312100001]]}]}
   :tierekisteriosoite {:alkuosa 1, :numero 20, :alkuetaisyys 0, :loppuetaisyys 0, :loppuosa 5}
   :alku #inst "1999-12-31T22:00:00.000-00:00"
   :loppu #inst "2017-01-31T22:00:00.000-00:00"})

(defn tarkista-oikeus-poikkeus [kutsu-fn]
  (try+
   (kutsu-fn)
   (is false "EiOikeutta poikkeusta ei heitetty")
   (catch EiOikeutta e
     (is true "EiOikeutta poikkeus heitetty"))))

(deftest vain-tilaaja-voi-hakea
  (tarkista-oikeus-poikkeus #(kutsu +kayttaja-urakan-vastuuhenkilo+ parametrit))
  (tarkista-oikeus-poikkeus #(kutsu :hae-reittipisteet-tienakymaan
                                    +kayttaja-urakan-vastuuhenkilo+ parametrit)))

(deftest tienakymahaku
  (let [tulos-kaikki-jvh (:tulos (kutsu +kayttaja-jvh+ parametrit))
        tulos-jvh (group-by :id tulos-kaikki-jvh)
        tulos-tero (group-by :id (:tulos (kutsu +kayttaja-tero+ parametrit)))]
    (is (= tulos-jvh tulos-tero) "Kaikki tilaajan käyttäjät saavat saman tuloksen")
    (is (= 7 (count tulos-jvh) (count tulos-tero)))

    (testing "Palautettu data on validia: infopaneelin tarvitsemat tiedot löytyvät"
      (is (paneeli/skeeman-luonti-onnistuu-kaikille? tulos-kaikki-jvh)))))

(deftest reittipistehaku
  (let [reittipisteet (kutsu :hae-reittipisteet-tienakymaan +kayttaja-jvh+ {:toteuma-id 1})]
    (is (= 8 (count reittipisteet)))))
